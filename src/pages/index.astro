---
export const prerender = false
import Layout from '../layouts/Layout.astro';
import axios, { type AxiosResponse } from "axios";
import { aResult, type Result } from "@volpe/utils";
import {type Category, type Course, type IAcademy} from "../env.d"
import Card from "../components/Card/Card.tsx";
import Market from "../components/Market/Market.astro"
import Test from '../components/Test.astro';

const currentTime = new Date().toLocaleTimeString();
Astro.response.headers.set('Cache-Control', 'public, maxage=100, s-maxage=300, stale-while-revalidate=100');

const api_qa = axios.create({
  baseURL: "https://qa.api.somosedison.com",
  headers: {
    Authorization: "l33hDPtjJK0emSag5NcJKdrJbWXUFpORTSih",
  },
});

// const ACADEMY_ID = "2a748937-dfff-419c-908e-fa16856e19fe" // EDISON
const ACADEMY_ID = "ffde42cb-1588-4928-8dd6-330b02ff26df" // ANKYRA
// const ACADEMY_ID="1c1c7102-c55c-4c93-a699-776492ab9001" // DEV
// const ACADEMY_ID="503b5ef4-07b1-477e-b1b0-e412a5f96658" // MONTERREY

const [err, axiosResponse] = await api_qa.get[aResult](`/courses/market/${ACADEMY_ID}`) as Result<AxiosResponse<Course[]>>;

if (err) throw err
if (!axiosResponse) throw err

const [academyError, axiosResponseAcademy] = await api_qa.get[aResult](`/academies/${ACADEMY_ID}`) as Result<AxiosResponse<IAcademy>>;

if (academyError) throw academyError
if (!axiosResponseAcademy) throw axiosResponseAcademy



const {data: courses} = axiosResponse
const {data: academy} = axiosResponseAcademy

const [categoriesError, axiosResponseCategories] = await api_qa.get[aResult](`/categories`) as Result<AxiosResponse<Category[]>>;

if (categoriesError) throw categoriesError
if (!axiosResponseCategories) throw axiosResponseCategories

const {data: allCategories} = axiosResponseCategories

let categories = allCategories?.filter((e: any) => e.academyId === academy?.id)
---

<Layout academy={academy}>

  hola<br/>
  {currentTime}
  <br/>
  
  <h1 class="h-[100px]">Im√°genes Optimizadas</h1>
  <Test server:defer/>
  <Market courses={courses} categories={categories}/>
</Layout>

